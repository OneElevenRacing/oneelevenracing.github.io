<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Poll Page</title>
  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>

  <script>
    var firebaseConfig = {
            apiKey: "AIzaSyDpH1j5UfMlGXLqHaK7lqVWi0CkGbfN9SI",
            authDomain: "one-eleven-app-7f282.firebaseapp.com",
            databaseURL: "https://one-eleven-app-7f282-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "one-eleven-app-7f282",
            storageBucket: "one-eleven-app-7f282.appspot.com",
            messagingSenderId: "503866403242",
            appId: "1:503866403242:ios:782e6c3e12ec99e66aa3d3"
        };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    // This checks user sign ins
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        console.log("User signed in:", user.uid);

        // Check if user is an admin
        firebase.database().ref(`drivers/${user.uid}/isAdmin`).once("value")
          .then(snapshot => {
            if (snapshot.exists() && snapshot.val() === true) {
              console.log("User is an admin");
              document.getElementById("adminControls").style.display = "block"; // Show poll creation form
            } else {
              console.log("User is NOT an admin");
            }
          })
          .catch(error => console.error("Error checking admin status:", error));

      } else {
        console.log("No user signed in");
      }
    });
  </script>
</head>

<body>
  <h1>Poll Page</h1>

  <!-- Button + Paragraph -->
  <div id="adminControls" style="display: none;">
    <h2>Create a Poll</h2>
    <label for="weekSelector">Choose a week:</label>
      <select id="weekSelector">
        <option value="0">This Week</option>        <!-- offset = 0 -->
        <option value="1">Next Week</option>        <!-- offset = 1 -->
        <option value="2">Week After Next</option>  <!-- offset = 2 -->
      </select>
    <label for="pollTitle">Poll Title:</label>
    <input type="text" id="pollTitle" placeholder="Enter a title" />
    <label for="pollOptions">Options (comma-separated):</label>
    <input type="text" id="pollOptions" placeholder="e.g. Mon, Tue, Wed" />
    <button id="createPollBtn">Create Poll</button>
    <p id="pollCreateStatus"></p>
  </div>
  

  <h2>Latest Poll</h2>
  

  <table id="responsesTable" border="1">
    <thead>
        <tr id="pollOptionsHeader"> 
            <th>Name</th> <!-- Name stays fixed -->
        </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
        <tr id="totalsRow">
            <th>Total</th> <!-- First column for totals label -->
        </tr>
    </tfoot>
</table>

<div id="latestPollContainer"></div>
  




<!-- This is the script that submits the form request-->
<script>
  // Get references to the DOM elements
  const weekSelector = document.getElementById('weekSelector');
  const pollTitleInput = document.getElementById('pollTitle'); 
  const pollOptionsInput = document.getElementById('pollOptions');

  // When the week dropdown changes, update title and options
  weekSelector.addEventListener('change', () => {
    // 1. Get the selected week offset (0 = this week, 1 = next week, etc.)
    const offset = parseInt(weekSelector.value, 10);
    
    // 2. Compute the start and end dates for that week
    const { mondayDate, sundayDate, daysArray } = getWeekDates(offset);
    
    // 3. Compute the ISO week number
    const weekNum = getWeekNumber(mondayDate);

    // 4. Format the date range (DD.MM for Monday & Sunday)
    const dd1 = String(mondayDate.getDate()).padStart(2,'0');
    const mm1 = String(mondayDate.getMonth()+1).padStart(2,'0');
    const dd2 = String(sundayDate.getDate()).padStart(2,'0');
    const mm2 = String(sundayDate.getMonth()+1).padStart(2,'0');

    // 5. Build the poll title in format: "YEAR Week XX Availability (DD.MM - DD.MM)"
    const year = mondayDate.getFullYear();
    const newTitle = `${year} Week ${weekNum} Availability (${dd1}.${mm1} - ${dd2}.${mm2})`;

    // 6. Auto-fill the poll title
    pollTitleInput.value = newTitle;

    // 7. Auto-fill the poll options with days (or use in code later)
    pollOptionsInput.value = daysArray.join(", ");
  });

  // This is the event listener for creating a poll
  document.getElementById('createPollBtn').addEventListener('click', async () => {
    const title = pollTitleInput.value.trim();
    const options = pollOptionsInput.value.trim().split(", ").map(opt => opt.trim());

    if (!title) {
      alert("Please select a week first.");
      return;
    }

    try {
      await db.collection("polls").add({
        title: title,
        createdAt: new Date(),
        active: true,
        options: options
      });

      alert("Poll created successfully!");
      pollTitleInput.value = "";
      pollOptionsInput.value = "";
    } catch (err) {
      console.error("Error creating poll:", err);
      alert("Failed to create poll.");
    }
  });
</script>


<!-- This is the script that fetches the poll data and displays it -->
<script>
  db.collection("polls").orderBy("createdAt", "desc").limit(1)
  .onSnapshot((snapshot) => {
    const latestContainer = document.getElementById('latestPollContainer');
    latestContainer.innerHTML = "";

    if (snapshot.empty) {
      latestContainer.textContent = "No polls found.";
      return;
    }

    const doc = snapshot.docs[0];
    const poll = doc.data();
    const pollId = doc.id; // ✅ Now pollId is properly defined!

    // Display poll title
    const heading = document.createElement('h3');
    heading.textContent = poll.title || "Unnamed Poll";
    latestContainer.appendChild(heading);

    // If the poll has options, build checkboxes
    if (poll.options && poll.options.length > 0) {
  poll.options.forEach(option => {
    const optionContainer = document.createElement('div');

    // Create a label or heading for the day
    const optionLabel = document.createElement('strong');
    optionLabel.textContent = option + ": ";
    optionContainer.appendChild(optionLabel);

    // Radio button values we'll allow
    const statuses = ["yes", "no", "maybe"];

    statuses.forEach(statusValue => {
      const radio = document.createElement('input');
      radio.type = "radio";
      radio.name = `option_${option}`;  // ensures only one selection per day
      radio.value = statusValue;

      // Add a text label
      const label = document.createElement('label');
      label.textContent = statusValue.charAt(0).toUpperCase() + statusValue.slice(1);

      optionContainer.appendChild(radio);
      optionContainer.appendChild(label);
      optionContainer.appendChild(document.createTextNode("  ")); // spacing
    });

    latestContainer.appendChild(optionContainer);
  });
}

    // Submit button
    const submitBtn = document.createElement('button');
    submitBtn.textContent = "Submit Availability";
    latestContainer.appendChild(submitBtn);

    // Status message
    const statusP = document.createElement('p');
    latestContainer.appendChild(statusP);

    // Handle Submit Click
    submitBtn.addEventListener('click', async () => {
      const user = firebase.auth().currentUser;
      if (!user) {
        statusP.textContent = "You must be signed in to submit availability.";
        return;
      }

      // We’ll build a dictionary: day → yes/no/maybe
      const dayResponses = {};

      // For each day in the poll
      (poll.options || []).forEach(option => {
        const radios = latestContainer.querySelectorAll(`input[name="option_${option}"]`);
        let selectedValue = null;
        radios.forEach(radio => {
          if (radio.checked) {
            selectedValue = radio.value; // "yes", "no", or "maybe"
          }
        });

        // If user didn't pick anything for that day, let's default to "no" or store null
        dayResponses[option] = selectedValue || "no";
      });

      try {
        await db.collection("polls").doc(pollId)
          .collection("responses").doc(user.uid)
          .set({
            submittedAt: new Date(),
            dayResponses: dayResponses // <-- store our dictionary
          });

        statusP.textContent = "Availability updated!";
      } catch (error) {
        console.error("Error saving availability:", error);
        statusP.textContent = "Failed to save.";
      }
    });
    fetchResponses(pollId);
  });

  function fetchResponses(pollId) {
  db.collection("polls").doc(pollId).get().then((pollDoc) => {
    if (!pollDoc.exists) return;
    
    const pollData = pollDoc.data();
    const pollOptions = pollData.options || [];

    const headerRow = document.getElementById("pollOptionsHeader");
    headerRow.innerHTML = "<th>Name</th>"; // Reset header, keep 'Name' column

    // Create table headers for each poll option (date)
    pollOptions.forEach(option => {
      const th = document.createElement("th");
      th.textContent = option;
      headerRow.appendChild(th);
    });

    // Now fetch the responses
    populateResponseTable(pollId, pollOptions);
  });
}

// This function figures out which week we're in
function getWeekNumber(dateObj) {
  // Create a copy so we don’t mutate the original date
  const d = new Date(Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()));
  // Sunday=0 => set to Monday as first day of the week
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  // first day of this year
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  // calc full weeks to the nearest Thursday
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  return weekNo;
}


// This function figures out which what days each week has
function getWeekDates(weekOffset = 0) {
  // 1) Figure out "today"
  const now = new Date();

  // 2) Start by finding the Monday of the current week
  //    (Assuming Monday is day 1 in your locale
  const dayOfWeek = now.getDay(); 
  // In JS, Sunday=0, Monday=1, ..., Saturday=6

  // We want Monday=1 to be a "special" reference
  // If dayOfWeek === 0 (Sunday), we treat it as day 7 for math
  const effectiveDay = dayOfWeek === 0 ? 7 : dayOfWeek;

  // Calculate how many days to go back to reach Monday
  const daysFromMonday = effectiveDay - 1; // Monday=1 => 0 offset

  // 3) The "current Monday" date:
  const currentMonday = new Date(now);
  currentMonday.setDate(now.getDate() - daysFromMonday);

  // 4) If we have a weekOffset (1 = next week, 2 = week after), push Monday forward
  const offsetDays = weekOffset * 7;
  currentMonday.setDate(currentMonday.getDate() + offsetDays);

  // 5) currentMonday is the Monday for that week
  //    Sunday is Monday + 6 days
  const thisSunday = new Date(currentMonday);
  thisSunday.setDate(thisSunday.getDate() + 6);

  // 6) Build an array of daily labels
  //    We'll loop from Monday (0) to Sunday (6)
  let daysArray = [];
  for (let i = 0; i < 7; i++) {
    const tempDate = new Date(currentMonday);
    tempDate.setDate(currentMonday.getDate() + i);

    // Convert day of week to string like "Mon", "Tue"
    const dayShortNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const dayName = dayShortNames[tempDate.getDay()];

    // Format the date as DD.MM
    const dd = String(tempDate.getDate()).padStart(2, '0');
    const mm = String(tempDate.getMonth() + 1).padStart(2, '0'); // months are 0-based

    daysArray.push(`${dayName} ${dd}.${mm}`);
  }

  return {
    mondayDate: currentMonday,  // Monday's Date object
    sundayDate: thisSunday,     // Sunday's Date object
    daysArray: daysArray        // e.g. ["Mon 17.03", "Tue 18.03", ...]
  };
}


// This function fills in the poll results table
function populateResponseTable(pollId, pollOptions) {
  db.collection("polls").doc(pollId).collection("responses")
    .onSnapshot((responseSnapshot) => {
      const responsesTable = document.getElementById("responsesTable").getElementsByTagName("tbody")[0];
      responsesTable.innerHTML = ""; // Clear old rows

      // Initialize totals as a nested object, one for each day
      // We'll store counts like totals["Mon"] = { yes: 0, no: 0, maybe: 0 };
      let totals = {};
      pollOptions.forEach(opt => {
        totals[opt] = { yes: 0, no: 0, maybe: 0 };
      });

      responseSnapshot.forEach(responseDoc => {
        const responseData = responseDoc.data();
        const userId = responseDoc.id; 

        // dayResponses is your new dictionary of day -> yes/no/maybe
        const dayResponses = responseData.dayResponses || {};

        // Query user name from Realtime Database
        firebase.database().ref(`drivers/${userId}/name`).once("value").then(snapshot => {
          const userName = snapshot.exists() ? snapshot.val() : userId; 

          // Create a new row
          const row = responsesTable.insertRow();
          const nameCell = row.insertCell(0);
          nameCell.textContent = userName;

          // For each day, show the person's choice
          pollOptions.forEach(option => {
            const choice = dayResponses[option] || "no"; // fallback to "no" if missing
            const cell = row.insertCell(-1);

            if (choice === "yes") {
              cell.textContent = "Yes";
              cell.style.backgroundColor = "lightgreen";
            } else if (choice === "maybe") {
              cell.textContent = "Maybe";
              cell.style.backgroundColor = "khaki"; // or some other color
            } else {
              cell.textContent = "No";
              cell.style.backgroundColor = "lightcoral";
            }

            // Increment totals
            if (choice === "yes") totals[option].yes++;
            else if (choice === "maybe") totals[option].maybe++;
            else totals[option].no++;
          });

          // Finally, update the totals row
          updateTotalsRow(totals, pollOptions);
        });
      });
    });
}


// This writes the totals per day
function updateTotalsRow(totals, pollOptions) {
  const totalsRow = document.getElementById("totalsRow");
  totalsRow.innerHTML = "<th>Total</th>"; // Keep first column for label

  pollOptions.forEach(option => {
    const totalCell = document.createElement("th");
    const dayTotals = totals[option]; // { yes: number, maybe: number, no: number }

    // Format: "YesCount (+MaybeCount)", e.g., "4 (+2)"
    totalCell.textContent = `${dayTotals.yes} (+${dayTotals.maybe})`;
    totalsRow.appendChild(totalCell);
  });
}

// This function creates the table
function updateTable(userName, selectedOptions) {
  const responsesTable = document.getElementById('responsesTable').getElementsByTagName('tbody')[0];
  const row = responsesTable.insertRow();
  const cellName = row.insertCell(0);
  const cellSelections = row.insertCell(1);

  cellName.textContent = userName;
  cellSelections.textContent = selectedOptions ? selectedOptions.join(", ") : "No selection";
}


</script>



</body>
</html>
