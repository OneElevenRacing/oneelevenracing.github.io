<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Poll Page</title>
  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>

  <script>
    var firebaseConfig = {
            apiKey: "AIzaSyDpH1j5UfMlGXLqHaK7lqVWi0CkGbfN9SI",
            authDomain: "one-eleven-app-7f282.firebaseapp.com",
            databaseURL: "https://one-eleven-app-7f282-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "one-eleven-app-7f282",
            storageBucket: "one-eleven-app-7f282.appspot.com",
            messagingSenderId: "503866403242",
            appId: "1:503866403242:ios:782e6c3e12ec99e66aa3d3"
        };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();
  </script>
</head>

<body>
  <h1>Poll Page Placeholder</h1>

  <!-- Button + Paragraph -->
    <h2>Create a Poll</h2>
  <label for="pollTitle">Poll Title:</label>
  <input type="text" id="pollTitle" placeholder="Enter a title" />
  <label for="pollOptions">Options (comma-separated):</label>
  <input type="text" id="pollOptions" placeholder="e.g. Mon, Tue, Wed" />
  <button id="createPollBtn">Create Poll</button>
  <p id="pollCreateStatus"></p>

  <h2>Latest Poll</h2>
  <div id="latestPollContainer"></div>

  <h2>All Polls</h2>
  <ul id="pollsList"></ul>

  <button id="testWriteBtn">Write Test Doc</button>
  <p id="writeStatus"></p>

  <h2>Existing Test Docs:</h2>
  <ul id="testDocsList"></ul>



  <!-- Put the click listener AFTER the button appears in HTML -->
  <script>
    document.getElementById('testWriteBtn').addEventListener('click', async () => {
      const writeStatus = document.getElementById('writeStatus');
      try {
        await db.collection("testCollection").add({
          message: "Hello from poll.html",
          timestamp: new Date()
        });
        writeStatus.textContent = "Document written successfully!";
      } catch (error) {
        console.error("Error writing document:", error);
        writeStatus.textContent = "Failed to write doc.";
      }
    });
  </script>

<!-- This is the script that submits the form request-->
<script>
    document.getElementById('createPollBtn').addEventListener('click', async () => {
        const pollTitleInput = document.getElementById('pollTitle');
        const pollOptionsInput = document.getElementById('pollOptions');
        const pollCreateStatus = document.getElementById('pollCreateStatus');

        const title = pollTitleInput.value.trim();
        const rawOptions = pollOptionsInput.value.trim();
        if (!title) {
            pollCreateStatus.textContent = "Please enter a poll title.";
            return;
        }

        // Convert comma-separated string into an array of trimmed items
        let optionsArray = [];
        if (rawOptions) {
            optionsArray = rawOptions.split(",").map(opt => opt.trim());
        }

        try {
            await db.collection("polls").add({
            title: title,
            createdAt: new Date(),
            active: true,
            options: optionsArray
            });
            pollCreateStatus.textContent = "Poll created!";
            pollTitleInput.value = "";
            pollOptionsInput.value = "";
        } catch (err) {
            console.error("Error creating poll:", err);
            pollCreateStatus.textContent = "Failed to create poll.";
        }
    });
  </script>

<!-- This is the script that fetches the poll data and displays it -->
<script>
    db.collection("polls").orderBy("createdAt", "desc").limit(1)
    .onSnapshot((snapshot) => {
        const latestContainer = document.getElementById('latestPollContainer');
        latestContainer.innerHTML = ""; // Clear old content

        if (snapshot.empty) {
        latestContainer.textContent = "No polls found.";
        return;
        }

        const doc = snapshot.docs[0];
        const poll = doc.data();
        const pollId = doc.id;

        // Create a heading for the poll
        const heading = document.createElement('h3');
        heading.textContent = poll.title || "Unnamed Poll";
        latestContainer.appendChild(heading);

        // If the poll has options, build a simple availability list
        if (poll.options && poll.options.length > 0) {
        poll.options.forEach(opt => {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = "checkbox";
            checkbox.value = opt;

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(" " + opt));
            latestContainer.appendChild(label);
            latestContainer.appendChild(document.createElement('br'));
        });
        }

        // A 'Submit' button
        const submitBtn = document.createElement('button');
        submitBtn.textContent = "Submit Availability";
        latestContainer.appendChild(submitBtn);

        // A status paragraph
        const statusP = document.createElement('p');
        latestContainer.appendChild(statusP);

        // Handle button click to store user selections
        submitBtn.addEventListener('click', async () => {
        // Gather all checked boxes
        const checkedOptions = [];
        latestContainer.querySelectorAll('input[type="checkbox"]').forEach(box => {
            if (box.checked) {
            checkedOptions.push(box.value);
            }
        });

        if (checkedOptions.length === 0) {
            statusP.textContent = "Please select at least one option.";
            return;
        }

        try {
            // Save responses in a subcollection 'responses'
            await db.collection("polls").doc(pollId)
            .collection("responses")
            .add({
                submittedAt: new Date(),
                selectedOptions: checkedOptions
            });

            statusP.textContent = "Availability saved!";
        } catch (error) {
            console.error("Error saving availability:", error);
            statusP.textContent = "Failed to save.";
        }
        });
    }, (error) => {
        console.error("Error fetching latest poll:", error);
    });

</script>
  

<!-- I think this script is the one that fetches and displays the data -->
  <script>
    function testCollectionListener() {
      const testDocsList = document.getElementById('testDocsList');
      db.collection("testCollection").onSnapshot((snapshot) => {
        testDocsList.innerHTML = ""; // Clear the list
        snapshot.forEach(doc => {
            const data = doc.data();
            const li = document.createElement('li');

            // Extract fields
            const msg = data.message || "(no message)";
            let dateString = "(no timestamp)";
            if (data.timestamp) {
                // Convert Firestore timestamp to a JS Date
                const dateObj = data.timestamp.toDate();
                dateString = dateObj.toLocaleString();
            }

            // Show them nicely
            li.textContent = `Message: ${msg} | Timestamp: ${dateString}`;
            testDocsList.appendChild(li);
        });
      }, (error) => {
        console.error("Snapshot error:", error);
      });
    }
  
    // Call our listener once, right away
    testCollectionListener();
  </script>

</body>
</html>
