<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="apple-touch-icon" sizes="180x180" href="Logos_and_icons/Icons/111_icon180.png">
  <link rel="apple-touch-icon" sizes="152x152" href="Logos_and_icons/Icons/111_icon152.png">
  <link rel="apple-touch-icon" sizes="120x120" href="Logos_and_icons/Icons/111_icon120.png">

  <link rel="icon" href="Logos_and_icons/Icons/111_icon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">

  <title>Poll Page</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="style_about.css">

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>

  <script>
    // Your Firebase config
    var firebaseConfig = {
        apiKey: "AIzaSyDpH1j5UfMlGXLqHaK7lqVWi0CkGbfN9SI",
        authDomain: "one-eleven-app-7f282.firebaseapp.com",
        databaseURL: "https://one-eleven-app-7f282-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "one-eleven-app-7f282",
        storageBucket: "one-eleven-app-7f282.appspot.com",
        messagingSenderId: "503866403242",
        appId: "1:503866403242:ios:782e6c3e12ec99e66aa3d3"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    // Check user sign in
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        console.log("User signed in:", user.uid);

        // Check if user is an admin
        firebase.database().ref(`drivers/${user.uid}/isAdmin`).once("value")
          .then(snapshot => {
            if (snapshot.exists() && snapshot.val() === true) {
              console.log("User is an admin");
              const adminButton = document.createElement('button');
              adminButton.textContent = "Go to Poll Admin Page";
              adminButton.addEventListener('click', () => {
                window.location.href = "poll_admin.html";
              });
              document.body.appendChild(adminButton);
            }
          })
          .catch(error => console.error("Error checking admin status:", error));
      } else {
        console.log("No user signed in");
      }
    });
  </script>
</head>

<div class="about-container" style="margin-top: 0px;">
  <body>
    <header>
      <a href="javascript:void(0);" class="back-button" id="back"
         onclick="window.location.href='main.html'"
         style="display: block; text-align: left;">
          <img src="Logos_and_icons/back.png" alt="Back">
      </a>
    </header>

    <h2 id="pollTitleHeader">Latest Poll</h2>

    <!-- Poll table for results -->
    <table id="responsesTable" border="1" style="display: table; margin-left: auto; margin-right: auto;">
      <thead>
        <tr id="pollOptionsHeader"> 
          <th>Name</th> <!-- Name stays fixed -->
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr id="totalsRow">
          <th>Total</th> <!-- First column for totals label -->
        </tr>
      </tfoot>
    </table>

    <div id="latestPollContainer" style="margin: 15px"></div>
  </body>
</div>

<!-- Main script: fetch poll data and display it -->
<script>
  db.collection("polls").orderBy("createdAt", "desc").limit(1)
    .onSnapshot((snapshot) => {
      const latestContainer = document.getElementById('latestPollContainer');
      latestContainer.innerHTML = "";

      if (snapshot.empty) {
        latestContainer.textContent = "No polls found.";
        return;
      }

      // The single poll doc
      const doc = snapshot.docs[0];
      const poll = doc.data();
      const pollId = doc.id;

      // If user isn't signed in, do nothing
      const user = firebase.auth().currentUser;
      if (!user) return;

      // Update the header with the poll title
      document.getElementById('pollTitleHeader').textContent = poll.title || "No poll available";

      // Predefine previousResponses for availability
      let previousResponses = {};

      // 1) Fetch the user's previous responses
      db.collection("polls").doc(pollId).collection("responses").doc(user.uid)
        .get()
        .then(docSnapshot => {
          if (docSnapshot.exists) {
            previousResponses = docSnapshot.data().dayResponses || {};
          } else {
            previousResponses = {};
          }

          // 2) NOW Build the table, after we've retrieved `previousResponses`

          // Create a table for yes/no/maybe
          const selectionTable = document.createElement('table');
          selectionTable.style.margin = "auto"; // center it
          selectionTable.border = "1";

          // Create table header
          const headerRow = document.createElement('tr');
          headerRow.innerHTML = "<th>Day</th><th>Yes</th><th>No</th><th>Maybe</th>";
          selectionTable.appendChild(headerRow);

          // If the poll has options, add them as rows
          if (poll.options && poll.options.length > 0) {
            const statuses = ["yes", "no", "maybe"];

            poll.options.forEach(option => {
              // Create a row for this day
              const row = document.createElement('tr');

              // Day cell
              const dayCell = document.createElement('td');
              dayCell.textContent = option;
              row.appendChild(dayCell);

              // Create 3 cells for Yes/No/Maybe radio buttons
              statuses.forEach(statusValue => {
                const cell = document.createElement('td');

                // Create the radio button
                const radio = document.createElement('input');
                radio.type = "radio";
                radio.name = `option_${option}`;
                radio.value = statusValue;

                // Check if this option was previously selected
                if (previousResponses[option] === statusValue) {
                  radio.checked = true; 
                }

                // Create a label for the radio
                const label = document.createElement('label');
                label.textContent = statusValue.charAt(0).toUpperCase() + statusValue.slice(1);

                // Add them to the cell
                cell.appendChild(radio);
                cell.appendChild(document.createTextNode(" "));
                cell.appendChild(label);

                row.appendChild(cell);
              });

              // Finally, add this row to the table
              selectionTable.appendChild(row);
            });
          }

          // Append the table to the page
          latestContainer.appendChild(selectionTable);

          // 3) Create the SUBMIT button
          const submitBtn = document.createElement('button');
          submitBtn.textContent = "Submit Availability";
          latestContainer.appendChild(submitBtn);

          // Status paragraph
          const statusP = document.createElement('p');
          latestContainer.appendChild(statusP);

          // Submit logic
          submitBtn.addEventListener('click', async () => {
            const user = firebase.auth().currentUser;
            if (!user) {
              statusP.textContent = "You must be signed in to submit availability.";
              return;
            }

            const dayResponses = {};

            // For each day in the poll, gather the radio button choice
            (poll.options || []).forEach(option => {
              const radios = latestContainer.querySelectorAll(`input[name="option_${option}"]`);
              let selectedValue = null;
              radios.forEach(radio => {
                if (radio.checked) {
                  selectedValue = radio.value;
                }
              });
              dayResponses[option] = selectedValue || "no";
            });

            try {
              await db.collection("polls").doc(pollId)
                .collection("responses").doc(user.uid)
                .set({
                  submittedAt: new Date(),
                  dayResponses: dayResponses
                });
              statusP.textContent = "Availability updated!";
            } catch (error) {
              console.error("Error saving availability:", error);
              statusP.textContent = "Failed to save.";
            }
          });

          // 4) Now load existing responses for the bottom table
          fetchResponses(pollId);
        })
        .catch(error => {
          console.error("Error fetching previous responses:", error);
        });
    });

  function fetchResponses(pollId) {
    db.collection("polls").doc(pollId).get().then((pollDoc) => {
      if (!pollDoc.exists) return;
      
      const pollData = pollDoc.data();
      const pollOptions = pollData.options || [];

      const headerRow = document.getElementById("pollOptionsHeader");
      headerRow.innerHTML = "<th>Name</th>"; // Reset header, keep 'Name' column

      // Create table headers for each poll option (date)
      pollOptions.forEach(option => {
        const th = document.createElement("th");
        th.textContent = option;
        headerRow.appendChild(th);
      });

      // Now fetch the responses
      populateResponseTable(pollId, pollOptions);
    });
  }

  function populateResponseTable(pollId, pollOptions) {
    db.collection("polls").doc(pollId).collection("responses")
      .onSnapshot((responseSnapshot) => {
        const responsesTable = document.getElementById("responsesTable").getElementsByTagName("tbody")[0];
        responsesTable.innerHTML = ""; // Clear old rows

        let totals = {};
        pollOptions.forEach(opt => {
          totals[opt] = { yes: 0, no: 0, maybe: 0 };
        });

        responseSnapshot.forEach(responseDoc => {
          const responseData = responseDoc.data();
          const userId = responseDoc.id; 
          const dayResponses = responseData.dayResponses || {};

          // Query user name from Realtime Database
          firebase.database().ref(`drivers/${userId}/name`).once("value").then(snapshot => {
            const userName = snapshot.exists() ? snapshot.val() : userId; 

            // Create a new row
            const row = responsesTable.insertRow();
            const nameCell = row.insertCell(0);
            nameCell.textContent = userName;

            // For each day, show the person's choice
            pollOptions.forEach(option => {
              const choice = dayResponses[option] || "no"; 
              const cell = row.insertCell(-1);

              if (choice === "yes") {
                cell.textContent = "Yes";
                cell.style.backgroundColor = "lightgreen";
              } else if (choice === "maybe") {
                cell.textContent = "Maybe";
                cell.style.backgroundColor = "khaki";
              } else {
                cell.textContent = "No";
                cell.style.backgroundColor = "lightcoral";
              }

              // Increment totals
              if (choice === "yes") totals[option].yes++;
              else if (choice === "maybe") totals[option].maybe++;
              else totals[option].no++;
            });

            // Finally, update the totals row
            updateTotalsRow(totals, pollOptions);
          });
        });
      });
  }

  function updateTotalsRow(totals, pollOptions) {
    const totalsRow = document.getElementById("totalsRow");
    totalsRow.innerHTML = "<th>Total</th>";

    pollOptions.forEach(option => {
      const totalCell = document.createElement("th");
      const dayTotals = totals[option];
      totalCell.textContent = `${dayTotals.yes} (+${dayTotals.maybe})`;
      totalsRow.appendChild(totalCell);
    });
  }
</script>

<footer>
  <a href="javascript:void(0);" class="footerbuttonnotselected" id="simracing" onclick="window.location.href='main.html'">
      <img src="Logos_and_icons/simracing.png" alt="Sim Racing">
      SIM RACING
  </a>

  <a href="javascript:void(0);" class="footerbuttonnotselected" id="karting" onclick="navigateToKartingPage()">
      <img src="Logos_and_icons/karting.png" alt="Karting">
      KARTING
  </a>

  <a href="javascript:void(0);" class="footerbuttonnotselected" id="settings" onclick="window.location.href='settings.html'">
      <img src="Logos_and_icons/settings.png" alt="Settings">
      SETTINGS
  </a>
</footer>

<style>
  #responsesTable th, #responsesTable td {
    padding: 3px; /* Some space inside cells */
    font-size: 0.8em;
  }
</style>

</html>
