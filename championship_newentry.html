<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Enter Race Results - One Eleven Racing</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
  <script src="tracks.js"></script>

  <script>
    // *** INITIALISE FIREBASE ***
    var firebaseConfig = {
      apiKey: "AIzaSyDpH1j5UfMlGXLqHaK7lqVWi0CkGbfN9SI",
      authDomain: "one-eleven-app-7f282.firebaseapp.com",
      databaseURL: "https://one-eleven-app-7f282-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "one-eleven-app-7f282",
      storageBucket: "one-eleven-app-7f282.appspot.com",
      messagingSenderId: "503866403242",
      appId: "1:503866403242:ios:782e6c3e12ec99e66aa3d3"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <style>
    table { border-collapse: collapse; width: 80%; }
    th, td { border: 1px solid #ccc; padding: 6px; }
  </style>
</head>

<body>
  <header>
    <h1>New Race Result Entry</h1>
  </header>

  <section>
    <button onclick="window.location.href='championship.html';">Back to Championship Page</button>
    <h2 id="seasonName">Loading current season...</h2>
  </section>

  <script>
  // *****************************************************
  // *                 PAGE CONTROLLER                  *
  // *****************************************************
  firebase.auth().onAuthStateChanged(user => {
    if (!user) {
      document.body.innerHTML = "<h2>You must be signed in to access this page.</h2>";
      return;
    }

    // ---- Load active championship season ----
    firebase.firestore().collection('championships')
      .where('isActive', '==', true)
      .limit(1)
      .get()
      .then(snapshot => {
        if (snapshot.empty) {
          document.getElementById('seasonName').textContent = 'No active season found.';
          return;
        }

        const seasonDoc  = snapshot.docs[0];
        const seasonId   = seasonDoc.id;
        const seasonData = seasonDoc.data();

        document.getElementById('seasonName').textContent = `Current Season: ${seasonData.seasonName}`;
        document.getElementById('seasonName').dataset.seasonId = seasonId;

        //--------------------------------------------------
        // Build race‑selection drop‑down
        //--------------------------------------------------
        const raceSelectContainer = document.createElement('div');
        raceSelectContainer.innerHTML = `
            <label for="raceSelect">Select a race:</label>
            <select id="raceSelect"></select>
            <p id="raceSelectionStatus"></p>`;
        document.body.appendChild(raceSelectContainer);

        const raceKeysSorted = Object.keys(seasonData.races || {})
          .sort((a, b) => parseInt(a.replace('race','')) - parseInt(b.replace('race','')));

        const raceSelect = document.getElementById('raceSelect');
        raceKeysSorted.forEach((key, i) => {
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = `Race ${i+1}: ${seasonData.races[key].trackName}`;
          raceSelect.appendChild(opt);
        });

        //--------------------------------------------------
        // Fetch active drivers (Realtime DB)
        //--------------------------------------------------
        firebase.database().ref('drivers').once('value')
          .then(snap => buildResultsUI(snap.val(), seasonId, raceSelect))
          .catch(err => {
            console.error('Error loading drivers', err);
            document.body.insertAdjacentHTML('beforeend', '<p>❌ Failed to load driver list.</p>');
          });
      })
      .catch(err => {
        console.error('Error loading active season', err);
        document.getElementById('seasonName').textContent = '❌ Failed to load active season';
      });
  });

  // *****************************************************
  // *                BUILD THE RESULTS UI              *
  // *****************************************************
  function buildResultsUI(driversData, seasonId, raceSelect) {
    if (!driversData) {
      document.body.insertAdjacentHTML('beforeend', '<p>⚠️ No drivers found in the database.</p>');
      return;
    }

    // ---- Helpers ----
    const driverOptions = Object.entries(driversData)
      .filter(([_, d]) => d.active)
      .map(([uid, d]) => ({ uid, name: d.name || `Unnamed Driver (${uid})` }));
    const MAX_POS = 8;

    //--------------------------------------------------
    //   1. Results table (position + two races)
    //--------------------------------------------------
    const section = document.createElement('section');
    section.innerHTML = '<h3>Enter Race Results</h3>';

    const table = document.createElement('table');
    const headerRow = document.createElement('tr');
    ['Position','Race 1 – Driver','Race 2 – Driver'].forEach(t => {
      const th = document.createElement('th'); th.textContent = t; headerRow.appendChild(th);
    });
    table.appendChild(headerRow);

    const race1Drops = [], race2Drops = [];

    for (let p=1; p<=MAX_POS; p++) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>P${p}</td>`;

      // helper to make one <select>
      const makeSelect = (race) => {
        const sel = document.createElement('select');
        sel.dataset.position = p;
        sel.dataset.race     = race;
        sel.style.width = '200px';
        // default option
        sel.appendChild(new Option('-- Select Driver --',''));
        driverOptions.forEach(opt => sel.appendChild(new Option(opt.name,opt.uid)));
        return sel;
      };

      const td1 = document.createElement('td'); const r1 = makeSelect('race1'); td1.appendChild(r1); race1Drops.push(r1);
      const td2 = document.createElement('td'); const r2 = makeSelect('race2'); td2.appendChild(r2); race2Drops.push(r2);

      tr.appendChild(td1); tr.appendChild(td2); table.appendChild(tr);
    }

    section.appendChild(table); document.body.appendChild(section);

    //--------------------------------------------------
    //   2. Bonus‑points dropdowns
    //--------------------------------------------------
    const bonusSec = document.createElement('section'); bonusSec.innerHTML='<h3>Bonus Points</h3>';
    const bonusFields = [
      { id:'polePositionDriver',            label:'Pole Position'              },
      { id:'fastestLapDriverR1',            label:'Fastest Lap – Race 1'       },
      { id:'fastestLapOffPodiumDriverR1',   label:'Fastest Lap (Off Podium) – R1' },
      { id:'fastestLapDriverR2',            label:'Fastest Lap – Race 2'       },
      { id:'fastestLapOffPodiumDriverR2',   label:'Fastest Lap (Off Podium) – R2' }
    ];
    bonusFields.forEach(f => {
      const lab = document.createElement('label'); lab.textContent = `${f.label}: `; lab.htmlFor = f.id;
      const sel = document.createElement('select'); sel.id = f.id; sel.appendChild(new Option('-- Select Driver --',''));
      driverOptions.forEach(o => sel.appendChild(new Option(o.name, o.uid)));
      bonusSec.appendChild(lab); bonusSec.appendChild(sel); bonusSec.appendChild(document.createElement('br'));
    });
    document.body.appendChild(bonusSec);

    //--------------------------------------------------
    //   3. Deduplication logic (hide used drivers)
    //--------------------------------------------------
    function attachDedupLogic(selectList) {
      selectList.forEach(sel => sel.addEventListener('change', () => {
        const used = new Set(selectList.map(s=>s.value).filter(Boolean));
        selectList.forEach(s => {
          Array.from(s.options).forEach(o => {
            if (!o.value) return; // keep default always visible
            o.hidden = used.has(o.value) && o.value !== s.value;
          });
        });
      }));
    }
    attachDedupLogic(race1Drops); attachDedupLogic(race2Drops);

    //--------------------------------------------------
    //   4. Pre‑loading helper
    //--------------------------------------------------
    function preloadDropdowns(resultsObj, dropdowns) {
      const dropdownByPos = {};
      dropdowns.forEach(sel => { sel.value=''; dropdownByPos[+sel.dataset.position] = sel; });

      const counts = {};
      Object.values(resultsObj).forEach(p => counts[p] = (counts[p]||0)+1);
      const maxPos        = Math.max(...Object.keys(counts).map(Number), 0);
      const lastIsShared  = counts[maxPos] > 1;

      Object.entries(resultsObj).forEach(([uid,pos]) => {
        if (pos === maxPos && lastIsShared) return; // non‑starters
        const drop = dropdownByPos[pos];
        if (drop) drop.value = uid;
      });
    }

    //--------------------------------------------------
    //   5. Race selector change → preload all fields
    //--------------------------------------------------
    raceSelect.addEventListener('change', () => {
      const raceKey = raceSelect.value; if (!raceKey) return;
      firebase.firestore().collection('championships').doc(seasonId).get()
        .then(doc => {
          const raceData = (doc.data().races || {})[raceKey] || {};
          preloadDropdowns(raceData.resultsRace1 || {}, race1Drops);
          preloadDropdowns(raceData.resultsRace2 || {}, race2Drops);

          // bonus
          bonusFields.forEach(f => {
            const el = document.getElementById(f.id);
            el.value = raceData[f.id] || '';
          });
        })
        .catch(err => console.error('Error loading race', err));
    });
    raceSelect.dispatchEvent(new Event('change')); // trigger initial load

    //--------------------------------------------------
    //   6. Save helper
    //--------------------------------------------------
    async function saveRace(raceNo) {
      const raceKey = raceSelect.value;
      const selList = raceNo===1 ? race1Drops : race2Drops;
      const results = {}; const chosen = [];
      selList.forEach(sel => {
        if (sel.value) { results[sel.value] = +sel.dataset.position; chosen.push(sel.value); }
      });

      // determine shared last value
      const currentMax = Math.max(...Object.values(results), 0);
      const sharedLast = Object.values(results).filter(p=>p===currentMax).length>1 ? currentMax : currentMax+1;

      // add DNS/DNF drivers
      driverOptions.forEach(o => { if (!chosen.includes(o.uid)) results[o.uid] = sharedLast; });

      // bonus fields
        const bonus = {};
        const bonusFieldIds = raceNo === 1
        ? ['polePositionDriver','fastestLapDriverR1','fastestLapOffPodiumDriverR1']
        : ['fastestLapDriverR2','fastestLapOffPodiumDriverR2'];

        bonusFieldIds.forEach(id => {
        const val = document.getElementById(id).value;
        bonus[`races.${raceKey}.${id}`] = val || firebase.firestore.FieldValue.delete();
        });


      const fieldName = raceNo===1 ? 'resultsRace1' : 'resultsRace2';
      await firebase.firestore().collection('championships').doc(seasonId).update({
        [`races.${raceKey}.${fieldName}`]: results,
        ...bonus
      });
      alert(`Race ${raceNo} results saved!`);
    }

    //--------------------------------------------------
    //   7. Action buttons
    //--------------------------------------------------
    const btnSec = document.createElement('section'); btnSec.style.marginTop='20px';
    const b1 = document.createElement('button'); b1.textContent='Submit Race 1 Results'; b1.onclick = () => saveRace(1);
    const b2 = document.createElement('button'); b2.textContent='Submit Race 2 Results'; b2.style.marginLeft='10px'; b2.onclick = () => saveRace(2);
    btnSec.appendChild(b1); btnSec.appendChild(b2); document.body.appendChild(btnSec);
  }
  </script>
</body>
</html>