<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Enter Race Results - One Eleven Racing</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>
  <script src="tracks.js"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyDpH1j5UfMlGXLqHaK7lqVWi0CkGbfN9SI",
      authDomain: "one-eleven-app-7f282.firebaseapp.com",
      databaseURL: "https://one-eleven-app-7f282-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "one-eleven-app-7f282",
      storageBucket: "one-eleven-app-7f282.appspot.com",
      messagingSenderId: "503866403242",
      appId: "1:503866403242:ios:782e6c3e12ec99e66aa3d3"
    };

    firebase.initializeApp(firebaseConfig);
  </script>
</head>

<body>
  <header>
    <h1>New Race Result Entry</h1>
  </header>

  <section>
    <button onclick="window.location.href='championship.html';">Back to Championship Page</button>
    <h2 id="seasonName">Loading current season...</h2>
  </section>

  <script>
    // Check if user is signed in
    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        document.body.innerHTML = "<h2>You must be signed in to access this page.</h2>";
        return;
      }

      // Load active season
      firebase.firestore().collection('championships')
        .where('isActive', '==', true)
        .limit(1)
        .get()
        .then(snapshot => {
            if (snapshot.empty) {
                document.getElementById('seasonName').textContent = "No active season found.";
                return;
            }

            const seasonDoc = snapshot.docs[0];
            const data = seasonDoc.data();
            document.getElementById('seasonName').textContent = `Current Season: ${data.seasonName}`;
            document.getElementById('seasonName').dataset.seasonId = seasonDoc.id;
            const raceSelectContainer = document.createElement('div');
            raceSelectContainer.innerHTML = `
            <label for="raceSelect">Select a race:</label>
            <select id="raceSelect">
                <option value="">Loading races...</option>
            </select>
            <p id="raceSelectionStatus"></p>
            `;
            document.body.appendChild(raceSelectContainer);

            const races = data.races; // races is an object: race1, race2, etc.
            const raceSelect = document.getElementById('raceSelect');
            raceSelect.innerHTML = ''; // clear the "Loading..." option

            let firstIncompleteRaceKey = null;
            let index = 1;

            const sortedRaceKeys = Object.keys(races).sort((a, b) => {
            const numA = parseInt(a.replace('race', ''));
            const numB = parseInt(b.replace('race', ''));
            return numA - numB;
            });

            sortedRaceKeys.forEach((raceKey, i) => {
            const raceInfo = races[raceKey];
            const option = document.createElement('option');
            option.value = raceKey;
            option.textContent = `Race ${i + 1}: ${raceInfo.trackName}`;

            if (!firstIncompleteRaceKey) {
                firstIncompleteRaceKey = raceKey;
                option.selected = true;
            }

            raceSelect.appendChild(option);
            });

            // Step: Fetch driver list from Realtime Database
            firebase.database().ref('drivers').once('value')
            .then(snapshot => {
                const driversData = snapshot.val();
                if (!driversData) {
                const warning = document.createElement('p');
                warning.textContent = "⚠️ No drivers found in the database.";
                document.body.appendChild(warning);
                return;
                }

                // Create the race results table section
                const resultsSection = document.createElement('section');
                resultsSection.innerHTML = `<h3>Enter Race Results</h3>`;

                // Create the table
                const table = document.createElement('table');
                table.setAttribute('id', 'raceResultsTable');
                table.style.borderCollapse = 'collapse';
                table.style.width = '100%';

                // Table header
                const headerRow = document.createElement('tr');

                ['Driver', 'Race 1 Position', 'Race 2 Position'].forEach(colName => {
                const th = document.createElement('th');
                th.textContent = colName;
                th.style.border = '1px solid #ccc';
                th.style.padding = '6px';
                headerRow.appendChild(th);
                });

                table.appendChild(headerRow);
                resultsSection.appendChild(table);
                document.body.appendChild(resultsSection);

                // Bonus Points Section
                const bonusSection = document.createElement('section');
                bonusSection.innerHTML = `<h3>Bonus Points</h3>`;
                bonusSection.style.marginTop = '20px';

                const bonusFields = [
                { id: 'polePositionDriver', label: 'Pole Position' },
                { id: 'fastestLapDriverR1', label: 'Fastest Lap – Race 1' },
                { id: 'fastestLapOffPodiumDriverR1', label: 'Fastest Lap (Off Podium) - Race 1' },
                { id: 'fastestLapDriverR2', label: 'Fastest Lap – Race 2' },
                { id: 'fastestLapOffPodiumDriverR2', label: 'Fastest Lap (Off Podium) - Race 2' }
                ];

                bonusFields.forEach(field => {
                const label = document.createElement('label');
                label.htmlFor = field.id;
                label.textContent = `${field.label}: `;

                const select = document.createElement('select');
                select.id = field.id;
                select.name = field.id;

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Select Driver --';
                select.appendChild(defaultOption);

                Object.entries(driversData).forEach(([uid, driver]) => {
                    if (!driver.active) return;
                    const option = document.createElement('option');
                    option.value = uid;
                    option.textContent = driver.name || `Unnamed Driver (${uid})`;
                    select.appendChild(option);
                });

                bonusSection.appendChild(label);
                bonusSection.appendChild(select);
                bonusSection.appendChild(document.createElement('br'));
                });

                document.body.appendChild(bonusSection);


                // Add rows for each active driver (names only for now)
                Object.entries(driversData).forEach(([uid, driver]) => {
                if (!driver.active) return;

                const row = document.createElement('tr');

                const nameCell = document.createElement('td');
                nameCell.textContent = driver.name || `Unnamed Driver (${uid})`;
                nameCell.style.border = '1px solid #ccc';
                nameCell.style.padding = '6px';

                const race1Cell = document.createElement('td');
                race1Cell.style.border = '1px solid #ccc';
                race1Cell.style.padding = '6px';
                const race1Input = document.createElement('input');
                race1Input.type = 'number';
                race1Input.min = '1';
                race1Input.max = '10';
                race1Input.placeholder = 'Position';
                race1Input.style.width = '100px';
                race1Input.dataset.uid = uid;
                race1Input.dataset.race = 'race1';
                race1Cell.appendChild(race1Input);

                const race2Cell = document.createElement('td');
                race2Cell.style.border = '1px solid #ccc';
                race2Cell.style.padding = '6px';
                const race2Input = document.createElement('input');
                race2Input.type = 'number';
                race2Input.min = '1';
                race2Input.max = '10';
                race2Input.placeholder = 'Position';
                race2Input.style.width = '100px';
                race2Input.dataset.uid = uid;
                race2Input.dataset.race = 'race2';
                race2Cell.appendChild(race2Input);


                row.appendChild(nameCell);
                row.appendChild(race1Cell);
                row.appendChild(race2Cell);

                table.appendChild(row);
                });

                raceSelect.addEventListener('change', () => {
                const selectedRaceKey = raceSelect.value;
                const seasonId = document.getElementById('seasonName').dataset.seasonId;

                if (!selectedRaceKey || !seasonId) return;

                firebase.firestore()
                    .collection('championships')
                    .doc(seasonId)
                    .get()
                    .then(doc => {
                    const seasonData = doc.data();
                    const raceData = seasonData.races[selectedRaceKey];

                    if (!raceData) return;

                    const race1Results = raceData.resultsRace1 || {};
                    const race2Results = raceData.resultsRace2 || {};

                    // Fill Race 1 inputs
                    document.querySelectorAll('input[data-race="race1"]').forEach(input => {
                        const uid = input.dataset.uid;
                        input.value = race1Results[uid] || '';
                    });

                    // Fill Race 2 inputs
                    document.querySelectorAll('input[data-race="race2"]').forEach(input => {
                        const uid = input.dataset.uid;
                        input.value = race2Results[uid] || '';
                    });
                    })
                    .catch(error => {
                    console.error("Error loading race results:", error);
                    });
                });


                const buttonSection = document.createElement('section');
                buttonSection.style.marginTop = '20px';

                const race1Submit = document.createElement('button');
                race1Submit.textContent = 'Submit Race 1 Results';
                race1Submit.style.marginRight = '10px';

                const race2Submit = document.createElement('button');
                race2Submit.textContent = 'Submit Race 2 Results';

                buttonSection.appendChild(race1Submit);
                buttonSection.appendChild(race2Submit);
                document.body.appendChild(buttonSection);

                // Trigger loading the initially selected race results
                raceSelect.dispatchEvent(new Event('change'));

                race1Submit.addEventListener('click', async () => {
                const seasonId = document.getElementById('seasonName').dataset.seasonId;
                const raceKey = document.getElementById('raceSelect').value;
                const inputs = document.querySelectorAll('input[data-race="race1"]');

                const results = {};
                inputs.forEach(input => {
                    const uid = input.dataset.uid;
                    const pos = parseInt(input.value);
                    if (!isNaN(pos)) {
                    results[uid] = pos;
                    }
                });

                // Grab bonus driver selections
                const poleDriver = document.getElementById('polePositionDriver').value;
                const flDriverR1 = document.getElementById('fastestLapDriverR1').value;
                const flOffPodiumR1 = document.getElementById('fastestLapOffPodiumDriverR1').value;

                // Prepare bonus data
                const bonusUpdatesR1 = {};
                if (poleDriver) bonusUpdatesR1[`races.${raceKey}.polePositionDriver`] = poleDriver;
                if (flDriverR1) bonusUpdatesR1[`races.${raceKey}.fastestLapDriverR1`] = flDriverR1;
                if (flOffPodiumR1) bonusUpdatesR1[`races.${raceKey}.fastestLapOffPodiumDriverR1`] = flOffPodiumR1;

                try {
                    await firebase.firestore()
                    .collection('championships')
                    .doc(seasonId)
                    .update({
                        [`races.${raceKey}.resultsRace1`]: results,
                        ...bonusUpdatesR1
                    });

                    alert("✅ Race 1 results saved to Firestore!");
                } catch (error) {
                    console.error("❌ Error saving Race 1 results:", error);
                    alert("❌ Failed to save Race 1 results.");
                }
                });


                race2Submit.addEventListener('click', async () => {
                const seasonId = document.getElementById('seasonName').dataset.seasonId;
                const raceKey = document.getElementById('raceSelect').value;
                const inputs = document.querySelectorAll('input[data-race="race2"]');

                const results = {};
                inputs.forEach(input => {
                    const uid = input.dataset.uid;
                    const pos = parseInt(input.value);
                    if (!isNaN(pos)) {
                    results[uid] = pos;
                    }
                });

                // Grab Race 2 bonus selections
                const flDriverR2 = document.getElementById('fastestLapDriverR2').value;
                const flOffPodiumR2 = document.getElementById('fastestLapOffPodiumDriverR2').value;

                // Prepare Race 2 bonus updates
                const bonusUpdatesR2 = {};
                if (flDriverR2) bonusUpdatesR2[`races.${raceKey}.fastestLapDriverR2`] = flDriverR2;
                if (flOffPodiumR2) bonusUpdatesR2[`races.${raceKey}.fastestLapOffPodiumDriverR2`] = flOffPodiumR2;


                try {
                    await firebase.firestore()
                    .collection('championships')
                    .doc(seasonId)
                    .update({
                        [`races.${raceKey}.resultsRace2`]: results,
                        ...bonusUpdatesR2
                    });

                    alert("✅ Race 2 results saved to Firestore!");
                } catch (error) {
                    console.error("❌ Error saving Race 2 results:", error);
                    alert("❌ Failed to save Race 2 results.");
                }
                });


            })
            .catch(error => {
                console.error("Error loading drivers:", error);
                const errorMsg = document.createElement('p');
                errorMsg.textContent = "❌ Failed to load driver list.";
                document.body.appendChild(errorMsg);
            });


        })
        .catch(error => {
          console.error("Error loading active season:", error);
          document.getElementById('seasonStatusMessage').textContent = "❌ Failed to load active season.";
        });
    });
  </script>
</body>
</html>
